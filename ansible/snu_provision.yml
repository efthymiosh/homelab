- hosts: snus
  become: true
  vars:
    consul_encrypt: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        36303239623836333836303561613532626638356431393763653762333365396363643531626533
        6365643632343962643961643663366134336438376166360a633461373761623737343635663931
        33353234326561316236623131356431373939316661613035656634623563396466653731663162
        6564643662663532310a383935666237376338656130356239376437343466643862366637656136
        65396435656364323536343233346562336635343735343737343761363866383962666636396538
        3634363065386137653437333736653564643139356439373538
    nomad_encrypt: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          62646635653265613934363632323662336631343764343035303065653639646266333964303165
          3432346464356463316466343461626536613031336665630a353865326335623031383731626265
          30623430383434633731646133653363303535343765626365646466356230306637633362616563
          6334663936316238650a353232643336623365326562356132376639666562653637316334396531
          30646366656564646561613932333661306363333031363763636661306332383636353461636439
          3834323933653035656162313565383063623163636537363738
    consul_register:
      services:
      - id: "consului"
        name: "cnsl"
        port: 8500
        tags:
        - "http"
        - "routed"
        - "traefik.http.routers.cnsl.rule=Host(`consul.efthymios.net`)"
      - id: "nomadui"
        name: "nmd"
        port: 4646
        tags: 
        - "http"
        - "routed"
        - "traefik.http.routers.nmd.rule=Host(`nomad.efthymios.net`)"
    consul_config:
      encrypt: "{{ consul_encrypt }}"
      datacenter: "homelab"
      server: true
      bootstrap_expect: 3
      ui_config:
        enabled: true
      performance:
        raft_multiplier: 1
      client_addr: "0.0.0.0"
      bind_addr: !unsafe '{{ GetPrivateInterfaces | exclude "name" "docker" | limit 1 | attr "address" }}'
      data_dir: "/var/lib/consul"
      log_level: "WARN"
      enable_syslog: false
      enable_debug: false
      retry_join: "{{ groups['snus'] | list }}"
      rejoin_after_leave: true
      leave_on_terminate: true
      skip_leave_on_interrupt: false
      dns_config:
        enable_truncate: true
        use_cache: true
      telemetry:
        disable_hostname: true
        prometheus_retention_time: "60s"
    nomad_config:
      region: "efth"
      datacenter: "homelab"
      data_dir: "{{ nomad_data_dir }}"
      leave_on_interrupt: true
      leave_on_terminate: true
      bind_addr: !unsafe '{{ GetPrivateInterfaces | exclude "name" "docker" | limit 1 | attr "address" }}'
      server:
        enabled: true
        bootstrap_expect: 3
        encrypt: "{{ nomad_encrypt }}"
      client:
        enabled: true
        node_class: "snunmu"
        options:
          docker.volumes.enabled: "true"
        network_interface: !unsafe '{{ GetPrivateInterfaces | exclude "name" "docker" | limit 1 | attr "name" }}'
      consul:
        address: "localhost:8500"
      telemetry:
        collection_interval: "1s"
        disable_hostname: true
        publish_allocation_metrics: true
        publish_node_metrics: true
        prometheus_metrics: true
  roles:
  - role: docker
    tags: docker
  - role: consul
    tags: consul
  - role: nomad
    tags: nomad
